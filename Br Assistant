<Application x:Class="BRDesktopAssistant.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             ShutdownMode="OnExplicitShutdown"
             StartupUri="MainWindow.xaml">
  <Application.Resources>
  </Application.Resources>
</Application>

using System.Windows;

namespace BRDesktopAssistant
{
    public partial class App : Application
    {
    }
}

<Project Sdk="Microsoft.NET.Sdk.WindowsDesktop">
  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net8.0-windows</TargetFramework>
    <UseWPF>true</UseWPF>
    <UseWindowsForms>true</UseWindowsForms>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <ApplicationIcon>Assets\br.ico</ApplicationIcon>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="System.Text.Json" Version="8.0.4" />
    <PackageReference Include="DocumentFormat.OpenXml" Version="3.0.2" />
  </ItemGroup>

  <ItemGroup>
    <None Include="Assets\br.ico" />
  </ItemGroup>
</Project>

<Window x:Class="BRDesktopAssistant.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="–ë&–† –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî Desktop" Height="720" Width="1040" MinHeight="560" MinWidth="880"
        Icon="Assets/br.ico" WindowStartupLocation="CenterScreen">
  <Grid Background="#0f172a">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π -->
    <StackPanel Orientation="Horizontal" Margin="16" Grid.Row="0">
      <Button Content="–°—á—ë—Ç" Margin="0,0,8,0" Padding="12,6" Click="Invoice_Click"/>
      <Button Content="–ù–∞–∫–ª–∞–¥–Ω–∞—è" Margin="0,0,8,0" Padding="12,6" Click="Waybill_Click"/>
      <Button Content="–ê–∫—Ç" Margin="0,0,8,0" Padding="12,6" Click="Act_Click"/>
      <Separator Width="20"/>
      <ToggleButton x:Name="SttToggle" Content="üéôÔ∏è –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ" Margin="0,0,8,0" Padding="12,6" Checked="SttToggle_Checked" Unchecked="SttToggle_Unchecked"/>
      <ToggleButton x:Name="TtsToggle" Content="üîä –û–∑–≤—É—á–∫–∞" Margin="0,0,8,0" Padding="12,6" IsChecked="True"/>
      <Separator Width="20"/>
      <Button Content="‚ö° –ü–æ–∑–≤–∞—Ç—å –ë–∏—Ä (Ctrl+Alt+B)" IsEnabled="False" Padding="12,6"/>
    </StackPanel>

    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <ScrollViewer Grid.Row="1" Name="HistoryScroll" VerticalScrollBarVisibility="Auto" Margin="16,0,16,0">
      <StackPanel Name="HistoryPanel" />
    </ScrollViewer>

    <!-- –í–≤–æ–¥ -->
    <DockPanel Grid.Row="2" Margin="16">
      <TextBox x:Name="PromptBox" DockPanel.Dock="Left" Height="60" FontSize="16"
               Background="#111827" Foreground="#e5e7eb" BorderBrush="#374151" BorderThickness="1"
               Padding="10" TextWrapping="Wrap" AcceptsReturn="True" VerticalContentAlignment="Center"
               ToolTip="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ Enter"/>
      <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" Margin="8,0,0,0">
        <Button x:Name="SendBtn" Content="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" Width="140" Height="60" Click="SendBtn_Click"
                Background="#2563eb" Foreground="White" BorderBrush="#2563eb"/>
      </StackPanel>
    </DockPanel>
  </Grid>
</Window>

using System;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Speech.Recognition;
using System.Speech.Synthesis;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Forms; // NotifyIcon
using System.Windows.Input;
using System.Windows.Media;
using BRDesktopAssistant.Models;
using BRDesktopAssistant.Services;
using BRDesktopAssistant.Utils;
using Application = System.Windows.Application;
using MessageBox = System.Windows.MessageBox;

namespace BRDesktopAssistant
{
    public partial class MainWindow : Window
    {
        private readonly OpenAIClient _client;
        private readonly ChatMessage[] _system;
        private readonly SpeechSynthesizer _tts = new SpeechSynthesizer();
        private SpeechRecognitionEngine? _stt;
        private readonly NotifyIcon _tray;
        private bool _startWithWindows = false;
        private readonly string _appData;
        private readonly string _docsDir;

        public MainWindow()
        {
            InitializeComponent();

            _appData = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), "BRDesktopAssistant");
            Directory.CreateDirectory(_appData);
            _docsDir = Path.Combine(_appData, "Documents");
            Directory.CreateDirectory(_docsDir);

            // OpenAI
            _client = new OpenAIClient();
            _system = new[]
            {
                new ChatMessage("system", "–¢—ã ‚Äî –≥–æ–ª–æ—Å–æ–≤–æ–π/—Ç–µ–∫—Å—Ç–æ–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ë&–† (–ë–∏–∑–Ω–µ—Å –∏ –†–∞–∑—É–º). –ü–æ–º–æ–≥–∞–µ—à—å –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—é: —Å–æ–∑–¥–∞—ë—à—å —Å—á–µ—Ç–∞, –Ω–∞–∫–ª–∞–¥–Ω—ã–µ, –∞–∫—Ç—ã (DOCX), –¥–∞—ë—à—å —Å–æ–≤–µ—Ç—ã –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ–¥–∞–∂–∞–º. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, —à–∞–≥–∞–º–∏, –Ω–∞ —Ä—É—Å—Å–∫–æ–º.")
            };

            // TTS
            try
            {
                _tts.Rate = 0;
                _tts.Volume = 100;
                // –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–±—Ä–∞—Ç—å —Ä—É—Å—Å–∫—É—é –≥–æ–ª–æ—Å–æ–≤—É—é
                var ru = _tts.GetInstalledVoices().FirstOrDefault(v => v.VoiceInfo.Culture.Name.StartsWith("ru", StringComparison.OrdinalIgnoreCase));
                if (ru != null) _tts.SelectVoice(ru.VoiceInfo.Name);
            }
            catch { }

            // STT –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–Ω–µ –≤–∫–ª—é—á–∞–µ–º –¥–æ –∫–ª–∏–∫–∞)
            InitTray();
            RegisterHotkey();

            PromptBox.KeyDown += async (s, e) =>
            {
                if (e.Key == Key.Enter && !Keyboard.IsKeyDown(Key.LeftShift))
                {
                    e.Handled = true;
                    await SendAsync();
                }
            };
        }

        private void InitTray()
        {
            _tray = new NotifyIcon();
            _tray.Icon = new System.Drawing.Icon(AppDomain.CurrentDomain.BaseDirectory + "Assets\\br.ico");
            _tray.Visible = true;
            _tray.Text = "–ë&–† –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç";

            var menu = new ContextMenuStrip();
            menu.Items.Add("–ü–æ–∫–∞–∑–∞—Ç—å –æ–∫–Ω–æ", null, (_, __) => { this.Show(); this.WindowState = WindowState.Normal; this.Activate(); });
            var ttsItem = new ToolStripMenuItem("–û–∑–≤—É—á–∫–∞ (TTS)") { Checked = true, CheckOnClick = true };
            ttsItem.CheckedChanged += (_, __) => { TtsToggle.IsChecked = ttsItem.Checked; };
            menu.Items.Add(ttsItem);
            var sttItem = new ToolStripMenuItem("–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (STT)") { Checked = false, CheckOnClick = true };
            sttItem.CheckedChanged += (_, __) => {
                if (sttItem.Checked) StartStt();
                else StopStt();
            };
            menu.Items.Add(sttItem);
            menu.Items.Add(new ToolStripSeparator());
            var autoStart = new ToolStripMenuItem("–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ Windows") { Checked = _startWithWindows, CheckOnClick = true };
            autoStart.CheckedChanged += (_, __) => { _startWithWindows = autoStart.Checked; StartupHelper.SetAutorun(_startWithWindows); };
            menu.Items.Add(autoStart);
            menu.Items.Add(new ToolStripSeparator());
            menu.Items.Add("–í—ã—Ö–æ–¥", null, (_, __) => { _tray.Visible = false; Application.Current.Shutdown(); });

            _tray.ContextMenuStrip = menu;
            _tray.DoubleClick += (_, __) => { this.Show(); this.WindowState = WindowState.Normal; this.Activate(); };
        }

        private void RegisterHotkey()
        {
            // Ctrl+Alt+B
            HotkeyManager.Register(this, HotkeyModifiers.MOD_CONTROL | HotkeyModifiers.MOD_ALT, System.Windows.Forms.Keys.B, () =>
            {
                this.Show();
                this.WindowState = WindowState.Normal;
                this.Activate();
                PromptBox.Focus();
            });
        }

        private Border MakeBubble(string text, bool isUser)
        {
            var tb = new TextBlock
            {
                Text = text,
                TextWrapping = TextWrapping.Wrap,
                Foreground = Brushes.White,
                Margin = new Thickness(10)
            };

            return new Border
            {
                Background = (isUser ? new SolidColorBrush((Color)ColorConverter.ConvertFromString("#1f2937"))
                                      : new SolidColorBrush((Color)ColorConverter.ConvertFromString("#111827"))),
                CornerRadius = new CornerRadius(12),
                Padding = new Thickness(4),
                Margin = new Thickness(0, 6, 0, 6),
                Child = tb,
                HorizontalAlignment = isUser ? HorizontalAlignment.Right : HorizontalAlignment.Left,
                MaxWidth = 760
            };
        }

        private async Task SendAsync()
        {
            var prompt = PromptBox.Text?.Trim();
            if (string.IsNullOrEmpty(prompt)) return;

            HistoryPanel.Children.Add(MakeBubble(prompt, true));
            PromptBox.Clear();
            HistoryScroll.ScrollToEnd();

            try
            {
                var messages = _system.Concat(new[] { new ChatMessage("user", prompt) }).ToArray();
                var reply = await _client.GetChatCompletionAsync(messages);

                HistoryPanel.Children.Add(MakeBubble(reply, false));
                HistoryScroll.ScrollToEnd();

                if (TtsToggle.IsChecked == true)
                {
                    try { _tts.SpeakAsyncCancelAll(); _tts.SpeakAsync(reply); } catch { }
                }
            }
            catch (Exception ex)
            {
                HistoryPanel.Children.Add(MakeBubble($"–û—à–∏–±–∫–∞: {ex.Message}", false));
                HistoryScroll.ScrollToEnd();
            }
        }

        // ==== STT ====
        private void StartStt()
        {
            try
            {
                if (_stt != null) return;
                var culture = new CultureInfo("ru-RU");
                try { _stt = new SpeechRecognitionEngine(culture); }
                catch { _stt = new SpeechRecognitionEngine(new CultureInfo("en-US")); }

                _stt.SetInputToDefaultAudioDevice();
                var dict = new Choices("—Å–æ–∑–¥–∞–π —Å—á—ë—Ç", "—Å–æ–∑–¥–∞–π –Ω–∞–∫–ª–∞–¥–Ω—É—é", "—Å–æ–∑–¥–∞–π –∞–∫—Ç", "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å", "–ø–æ–∑–≤–∞—Ç—å –±–∏—Ä");
                var gb = new GrammarBuilder(dict) { Culture = _stt.RecognizerInfo.Culture };
                var grammar = new Grammar(gb);
                _stt.LoadGrammar(grammar);
                _stt.SpeechRecognized += (s, e) =>
                {
                    var text = e.Result?.Text ?? "";
                    if (text.Contains("—Å—á—ë—Ç")) Invoice_Click(this, new RoutedEventArgs());
                    else if (text.Contains("–Ω–∞–∫–ª–∞–¥–Ω—É—é")) Waybill_Click(this, new RoutedEventArgs());
                    else if (text.Contains("–∞–∫—Ç")) Act_Click(this, new RoutedEventArgs());
                    else if (text.Contains("–æ—Ç–ø—Ä–∞–≤–∏—Ç—å")) _ = SendAsync();
                    else if (text.Contains("–±–∏—Ä")) HotkeyManager.Trigger();
                };
                _stt.RecognizeAsync(RecognizeMode.Multiple);
                SttToggle.IsChecked = true;
            }
            catch (Exception ex)
            {
                MessageBox.Show("STT –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å: " + ex.Message);
                SttToggle.IsChecked = false;
            }
        }

        private void StopStt()
        {
            try
            {
                _stt?.RecognizeAsyncStop();
                _stt = null;
            }
            catch { }
        }

        private void SttToggle_Checked(object sender, RoutedEventArgs e) => StartStt();
        private void SttToggle_Unchecked(object sender, RoutedEventArgs e) => StopStt();

        // ==== –î–æ–∫—É–º–µ–Ω—Ç—ã ====
        private void Invoice_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var path = DocService.CreateInvoice(_docsDir, "–û—Ä–ª–æ–≤", "–ï—Ä–æ—Ö–∏–Ω", "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞", 1, 30000m);
                HistoryPanel.Children.Add(MakeBubble($"–°—á—ë—Ç —Å–æ–∑–¥–∞–Ω: {path}", false));
                HistoryScroll.ScrollToEnd();
            }
            catch (Exception ex) { HistoryPanel.Children.Add(MakeBubble($"–û—à–∏–±–∫–∞ —Å—á—ë—Ç–∞: {ex.Message}", false)); }
        }
        private void Waybill_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var path = DocService.CreateWaybill(_docsDir, "–û—Ä–ª–æ–≤", "–ï—Ä–æ—Ö–∏–Ω", "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞", 1, 30000m);
                HistoryPanel.Children.Add(MakeBubble($"–ù–∞–∫–ª–∞–¥–Ω–∞—è —Å–æ–∑–¥–∞–Ω–∞: {path}", false));
                HistoryScroll.ScrollToEnd();
            }
            catch (Exception ex) { HistoryPanel.Children.Add(MakeBubble($"–û—à–∏–±–∫–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ–π: {ex.Message}", false)); }
        }
        private void Act_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var path = DocService.CreateAct(_docsDir, "–û—Ä–ª–æ–≤ –ö–∏—Ä–∏–ª–ª –ï–≤–≥–µ–Ω—å–µ–≤–∏—á", "–ï—Ä–æ—Ö–∏–Ω –ê–Ω–¥—Ä–µ–π –ù–∏–∫–æ–ª–∞–µ–≤–∏—á", "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞", 30000m);
                HistoryPanel.Children.Add(MakeBubble($"–ê–∫—Ç —Å–æ–∑–¥–∞–Ω: {path}", false));
                HistoryScroll.ScrollToEnd();
            }
            catch (Exception ex) { HistoryPanel.Children.Add(MakeBubble($"–û—à–∏–±–∫–∞ –∞–∫—Ç–∞: {ex.Message}", false)); }
        }

        protected override void OnStateChanged(EventArgs e)
        {
            base.OnStateChanged(e);
            if (WindowState == WindowState.Minimized) this.Hide();
        }

        protected override void OnClosed(EventArgs e)
        {
            _tray.Visible = false;
            HotkeyManager.Unregister(this);
            base.OnClosed(e);
        }
    }
}

# –ë&–† –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç ‚Äî PRO (WPF .NET 8)

–§—É–Ω–∫—Ü–∏–∏:
- –ß–∞—Ç —Å GPT (OpenAI API)
- –ì–æ–ª–æ—Å: –æ–∑–≤—É—á–∫–∞ (TTS), —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ (STT)
- –ö–Ω–æ–ø–∫–∏: –°—á—ë—Ç, –ù–∞–∫–ª–∞–¥–Ω–∞—è, –ê–∫—Ç ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è DOCX –≤ `%AppData%\BRDesktopAssistant\Documents`
- –¢—Ä–µ–π-–∏–∫–æ–Ω–∫–∞, –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ Windows —á–µ—Ä–µ–∑ —Ä–µ–µ—Å—Ç—Ä, –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ö–æ—Ç–∫–µ–π **Ctrl+Alt+B** (¬´–ü–æ–∑–≤–∞—Ç—å –ë–∏—Ä¬ª)
- –ò–∫–æ–Ω–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –°–±–æ—Ä–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ .NET 8 SDK
2. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `OPENAI_API_KEY`
3. –í –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞:
```
dotnet restore
dotnet run
```
–ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ –æ–¥–∏–Ω exe:
```
dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true
```

## –ì–æ–ª–æ—Å
- TTS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –≥–æ–ª–æ—Å Windows; –µ—Å–ª–∏ –µ—Å—Ç—å —Ä—É—Å—Å–∫–∏–π ‚Äî –≤—ã–±–µ—Ä–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
- STT –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã: ¬´—Å–æ–∑–¥–∞–π —Å—á—ë—Ç / –Ω–∞–∫–ª–∞–¥–Ω—É—é / –∞–∫—Ç¬ª, ¬´–æ—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª, ¬´–ø–æ–∑–≤–∞—Ç—å –±–∏—Ä¬ª.

## –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
–ì–æ—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –ª–µ–∂–∞—Ç –≤ `%AppData%\BRDesktopAssistant\Documents`.
